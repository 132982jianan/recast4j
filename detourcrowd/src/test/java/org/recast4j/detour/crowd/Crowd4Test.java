package org.recast4j.detour.crowd;

import org.junit.Assert;
import org.junit.Test;

public class Crowd4Test extends AbstractCrowdTest {

	static final float[][] EXPECTED_A1Q2TVTA = {
			{23.252523f,10.197294f,-46.263931f,0.061640f,0.000000f,0.073828f},
			{23.323601f,10.197294f,-46.378761f,-0.024148f,0.000000f,-0.093096f},
			{23.326368f,10.197294f,-46.426983f,-0.024448f,0.000000f,-0.093018f},
			{23.045410f,10.197294f,-46.400833f,-3.098990f,0.000000f,1.626734f},
			{22.888750f,10.197294f,-46.360519f,-0.783301f,0.000000f,0.201564f},
			{22.485508f,10.197294f,-46.290138f,-2.016209f,0.000000f,0.351901f},
			{21.968750f,10.197294f,-46.116749f,-2.583791f,0.000000f,0.866943f},
			{21.389566f,10.197294f,-45.876469f,-2.895921f,0.000000f,1.201408f},
			{20.782351f,10.197294f,-45.588245f,-3.036080f,0.000000f,1.441117f},
			{20.166676f,10.197294f,-45.322563f,-3.078375f,0.000000f,1.328412f},
			{19.552202f,10.197294f,-45.054111f,-3.072366f,0.000000f,1.342251f},
			{18.938997f,10.197294f,-44.782776f,-3.066021f,0.000000f,1.356681f},
			{18.327135f,10.197294f,-44.508427f,-3.059308f,0.000000f,1.371752f},
			{17.716698f,10.197294f,-44.230923f,-3.052190f,0.000000f,1.387519f},
			{17.148668f,10.197294f,-43.934566f,-2.840151f,0.000000f,1.481783f},
			{16.589767f,10.197294f,-43.605747f,-2.794508f,0.000000f,1.644090f},
			{15.988981f,10.197294f,-43.246502f,-3.003930f,0.000000f,1.796220f},
			{15.388652f,10.197294f,-42.886497f,-3.001648f,0.000000f,1.800030f},
			{14.788836f,10.197294f,-42.525635f,-2.999080f,0.000000f,1.804306f},
			{14.189600f,10.197294f,-42.163811f,-2.996175f,0.000000f,1.809125f},
			{13.591025f,10.197294f,-41.800896f,-2.992872f,0.000000f,1.814585f},
			{12.993206f,10.197294f,-41.436737f,-2.989096f,0.000000f,1.820799f},
			{12.382282f,10.197294f,-41.112614f,-3.054621f,0.000000f,1.620620f},
			{11.821070f,10.197294f,-40.803539f,-2.806062f,0.000000f,1.545365f},
			{11.261972f,10.197294f,-40.490654f,-2.795484f,0.000000f,1.564419f},
			{10.705238f,10.197294f,-40.173584f,-2.783668f,0.000000f,1.585348f},
			{10.151164f,10.197294f,-39.851891f,-2.770371f,0.000000f,1.608471f},
			{9.600107f,10.197294f,-39.525055f,-2.755283f,0.000000f,1.634182f},
			{9.052506f,10.197294f,-39.192459f,-2.738004f,0.000000f,1.662971f},
			{8.508904f,10.197294f,-38.853367f,-2.718008f,0.000000f,1.695455f},
			{7.969986f,10.197294f,-38.506882f,-2.694592f,0.000000f,1.732428f},
			{7.436626f,10.197294f,-38.151897f,-2.666799f,0.000000f,1.774914f},
			{6.909968f,10.197294f,-37.787045f,-2.633289f,0.000000f,1.824260f},
			{6.391541f,10.197294f,-37.410591f,-2.592139f,0.000000f,1.882272f},
			{5.883441f,10.197294f,-37.020309f,-2.540497f,0.000000f,1.951414f},
			{5.400005f,10.197294f,-36.577297f,-2.417177f,0.000000f,2.215067f},
			{4.891123f,10.197294f,-36.157207f,-2.544412f,0.000000f,2.100442f},
			{4.398879f,10.197294f,-35.788349f,-2.461220f,0.000000f,1.844290f},
			{3.968306f,10.197294f,-35.349068f,-2.152866f,0.000000f,2.196400f},
			{3.566400f,10.197294f,-34.786255f,-2.009527f,0.000000f,2.814057f},
			{3.210127f,10.197294f,-34.183701f,-1.781365f,0.000000f,3.012763f},
			{2.863452f,10.197294f,-33.575577f,-1.733375f,0.000000f,3.040627f},
			{2.532558f,10.197294f,-32.958721f,-1.654471f,0.000000f,3.084270f},
			{2.230496f,10.197294f,-32.327248f,-1.510310f,0.000000f,3.157367f},
			{1.991621f,10.197294f,-31.669268f,-1.194376f,0.000000f,3.289904f},
			{1.971748f,10.197294f,-30.969549f,-0.099365f,0.000000f,3.498589f},
			{1.851918f,10.197294f,-30.279882f,-0.599151f,0.000000f,3.448336f},
			{1.878970f,10.197294f,-29.606220f,0.135258f,0.000000f,3.368313f},
			{2.142403f,10.197294f,-28.957682f,1.317166f,0.000000f,3.242695f},
			{2.405836f,10.197294f,-28.309143f,1.317166f,0.000000f,3.242695f},
			{2.669269f,10.197294f,-27.660604f,1.317166f,0.000000f,3.242695f},
			{2.932702f,10.197294f,-27.012066f,1.317166f,0.000000f,3.242695f},
			{3.196136f,10.197294f,-26.363527f,1.317166f,0.000000f,3.242695f},
			{3.459569f,10.197294f,-25.714989f,1.317166f,0.000000f,3.242695f},
			{3.723002f,10.197294f,-25.066450f,1.317166f,0.000000f,3.242695f},
			{3.986435f,10.197294f,-24.417912f,1.317166f,0.000000f,3.242696f},
			{4.249868f,10.197294f,-23.769373f,1.317166f,0.000000f,3.242696f},
			{4.513301f,10.197294f,-23.120834f,1.317165f,0.000000f,3.242696f},
			{4.776734f,10.197294f,-22.472296f,1.317165f,0.000000f,3.242696f},
			{5.040167f,10.197294f,-21.823757f,1.317165f,0.000000f,3.242696f},
			{5.303600f,10.197294f,-21.175219f,1.317165f,0.000000f,3.242696f},
			{5.567033f,10.197294f,-20.526680f,1.317165f,0.000000f,3.242696f},
			{5.766881f,10.197294f,-19.897795f,0.999238f,0.000000f,3.144425f},
			{6.116602f,10.197294f,-19.398840f,1.767410f,0.000000f,2.516996f},
			{6.263040f,10.197294f,-19.001421f,1.377730f,0.000000f,2.619251f},
			{6.026742f,10.197294f,-18.472801f,0.395763f,0.000000f,3.189698f},
			{6.168289f,10.197294f,-18.145571f,1.275984f,0.000000f,0.410820f},
			{6.060094f,10.197294f,-17.969347f,-0.615795f,0.000000f,0.798246f},
			{6.136062f,10.197294f,-17.971029f,1.143502f,0.000000f,-0.920204f},
			{6.159475f,10.197294f,-17.940205f,0.117063f,0.000000f,0.154122f},
			{6.118867f,10.197294f,-17.941698f,-0.203037f,0.000000f,-0.007466f},
			{6.100112f,10.197294f,-17.942989f,-0.093775f,0.000000f,-0.006452f},
			{6.084951f,10.197294f,-17.963202f,-0.075806f,0.000000f,-0.101065f},
			{6.051520f,10.197294f,-17.976879f,-0.167158f,0.000000f,-0.068390f},
			{6.022295f,10.197294f,-17.995491f,-0.146124f,0.000000f,-0.093063f},
			{5.996701f,10.197294f,-18.017742f,-0.127972f,0.000000f,-0.111253f},
			{5.974288f,10.197294f,-18.042721f,-0.112062f,0.000000f,-0.124891f},
			{5.954719f,10.197294f,-18.069778f,-0.097848f,0.000000f,-0.135292f},
			{5.937741f,10.197294f,-18.098448f,-0.084891f,0.000000f,-0.143347f},
			{5.923171f,10.197294f,-18.128380f,-0.072851f,0.000000f,-0.149656f},
			{5.910877f,10.197294f,-18.159304f,-0.061468f,0.000000f,-0.154623f},
			{5.900767f,10.197294f,-18.191008f,-0.050550f,0.000000f,-0.158518f},
			{5.892775f,10.197294f,-18.223312f,-0.039960f,0.000000f,-0.161519f},
			{5.886854f,10.197294f,-18.256062f,-0.029603f,0.000000f,-0.163746f},
			{5.886842f,10.197294f,-18.332695f,-0.000060f,0.000000f,-0.383168f},
			{5.895481f,10.197294f,-18.408646f,0.043192f,0.000000f,-0.379752f},
			{5.913136f,10.197294f,-18.482899f,0.088279f,0.000000f,-0.371263f},
			{5.926807f,10.197294f,-18.565672f,0.068352f,0.000000f,-0.413868f},
			{5.944862f,10.197294f,-18.686159f,0.090276f,0.000000f,-0.602436f},
			{5.960392f,10.197294f,-18.807966f,0.077648f,0.000000f,-0.609038f},
			{5.974216f,10.197294f,-18.910067f,0.069123f,0.000000f,-0.510502f},
			{6.011487f,10.197294f,-18.995464f,0.186356f,0.000000f,-0.426987f},
			{6.064961f,10.197294f,-19.065414f,0.267370f,0.000000f,-0.349750f},
			{6.146883f,10.197294f,-19.161551f,0.409608f,0.000000f,-0.480682f},
			{6.246390f,10.197294f,-19.231236f,0.497534f,0.000000f,-0.348423f},
			{6.356504f,10.197294f,-19.276920f,0.550571f,0.000000f,-0.228421f},
			{6.459914f,10.197294f,-19.336788f,0.517048f,0.000000f,-0.299342f},
			{6.569193f,10.197294f,-19.369154f,0.546396f,0.000000f,-0.161831f},
			{6.682152f,10.197294f,-19.398115f,0.564794f,0.000000f,-0.144804f},
			{6.791424f,10.197294f,-19.364323f,0.546362f,0.000000f,0.168960f},
			{6.884709f,10.197294f,-19.325340f,0.466424f,0.000000f,0.194914f},			};

	@Test
	public void testAgent1Quality2TVTA() {
		int updateFlags = CrowdAgent.DT_CROWD_ANTICIPATE_TURNS | CrowdAgent.DT_CROWD_OPTIMIZE_VIS
				| CrowdAgent.DT_CROWD_OPTIMIZE_TOPO | CrowdAgent.DT_CROWD_OBSTACLE_AVOIDANCE;

		addAgentGrid(2, 0.3f, updateFlags, 2, startPoss[0]);
		for (CrowdAgent ag : crowd.getActiveAgents()) {
			crowd.requestMoveTarget(ag.getAgentIndex(), endRefs[0], endPoss[0]);
		}
		for (int i = 0; i < EXPECTED_A1Q2TVTA.length; i++) {
			crowd.update(1 / 5f, null);
			CrowdAgent ag = crowd.getAgent(2);
			dumpActiveAgents(i);
			Assert.assertEquals(EXPECTED_A1Q2TVTA[i][0], ag.npos[0], 0.001f);
			Assert.assertEquals(EXPECTED_A1Q2TVTA[i][1], ag.npos[1], 0.001f);
			Assert.assertEquals(EXPECTED_A1Q2TVTA[i][2], ag.npos[2], 0.001f);
			Assert.assertEquals(EXPECTED_A1Q2TVTA[i][3], ag.nvel[0], 0.001f);
			Assert.assertEquals(EXPECTED_A1Q2TVTA[i][4], ag.nvel[1], 0.001f);
			Assert.assertEquals(EXPECTED_A1Q2TVTA[i][5], ag.nvel[2], 0.001f);
		}
	}

}
